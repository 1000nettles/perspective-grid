(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.PerspectiveGrid=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _Point=require("./Point");var _Point2=_interopRequireDefault(_Point);var _MathHelper=require("./MathHelper");var LineEquation=function(){function LineEquation(lineParams,x){_classCallCheck(this,LineEquation);this.vertical=lineParams===null;if(this.vertical){this.x=x}else{this.m=lineParams.m;this.c=lineParams.c}}_createClass(LineEquation,[{key:"intersect",value:function intersect(equation){if(this.vertical&&equation.vertical){return null}if(this.vertical){return new _Point2["default"](this.x,(0,_MathHelper.getVerticalConvergence)(this.x,equation.m,equation.c))}if(equation.vertical){return new _Point2["default"](equation.x,(0,_MathHelper.getVerticalConvergence)(equation.x,this.m,this.c))}return(0,_MathHelper.getConvergencePoint)(this.m,this.c,equation.m,equation.c)}}]);return LineEquation}();exports["default"]=LineEquation;module.exports=exports["default"]},{"./MathHelper":2,"./Point":3}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getDistance=getDistance;exports.getConvergencePoint=getConvergencePoint;exports.getVerticalConvergence=getVerticalConvergence;exports.getLineParams=getLineParams;exports.getParallelLine=getParallelLine;exports.getDistanceToLine=getDistanceToLine;exports.getProjectedPoint=getProjectedPoint;exports.getMassCenter=getMassCenter;function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _Point=require("./Point");var _Point2=_interopRequireDefault(_Point);var EPSILON=1e-4;exports.EPSILON=EPSILON;var PI=Math.PI;exports.PI=PI;var TWO_PI=PI*2;exports.TWO_PI=TWO_PI;function getDistance(point1,point2){return Math.sqrt(Math.pow(point1.x-point2.x,2)+Math.pow(point1.y-point2.y,2))}function getConvergencePoint(m1,c1,m2,c2){if(Math.abs(m1-m2)<EPSILON){return null}var point=new _Point2["default"];point.x=(c2-c1)/(m1-m2);point.y=point.x*m1+c1;return point}function getVerticalConvergence(x,m,c){return m*x+c}function getLineParams(x1,y1,x2,y2){var dx=x1-x2;if(Math.abs(dx)<EPSILON){return null}var m=(y1-y2)/dx;var c=y1-m*x1;return{m:m,c:c}}function getParallelLine(line,point){var c=point.y-line.m*point.x;return{m:line.m,c:c}}function getDistanceToLine(line,point){return getDistance(point,getProjectedPoint(line,point))}function getProjectedPoint(line,point){var perpendicularm=-1/line.m;var perpendicularc=point.y-perpendicularm*point.x;var x=(line.c-perpendicularc)/(perpendicularm-line.m);var y=line.m*x+line.c;return new _Point2["default"](x,y)}function getMassCenter(p1,p2,p3,p4){return new _Point2["default"]((p1.x+p2.x+p3.x+p4.x)/4,(p1.y+p2.y+p3.y+p4.y)/4)}},{"./Point":3}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Point=function(){function Point(x,y){_classCallCheck(this,Point);this.x=x;this.y=y}_createClass(Point,[{key:"isInList",value:function isInList(list){for(var i=0,len=list.length;i<len;i++){if(this.x===list[i].x&&this.y===list[i].y){return true}}return false}}]);return Point}();exports["default"]=Point;module.exports=exports["default"]},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _LineEquation=require("./LineEquation");var _LineEquation2=_interopRequireDefault(_LineEquation);var _MathHelper=require("./MathHelper");var Segment=function(){function Segment(p1,p2){_classCallCheck(this,Segment);this.p1=p1;this.p2=p2}_createClass(Segment,[{key:"intersect",value:function intersect(segment){var line1=new _LineEquation2["default"]((0,_MathHelper.getLineParams)(this.p1.x,this.p1.y,this.p2.x,this.p2.y),this.p1.x);var line2=new _LineEquation2["default"]((0,_MathHelper.getLineParams)(segment.p1.x,segment.p1.y,segment.p2.x,segment.p2.y),segment.p1.x);return line1.intersect(line2)}}]);return Segment}();exports["default"]=Segment;module.exports=exports["default"]},{"./LineEquation":1,"./MathHelper":2}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj["default"]=obj;return newObj}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var _libPoint=require("./lib/Point");var _libPoint2=_interopRequireDefault(_libPoint);var _libSegment=require("./lib/Segment");var _libSegment2=_interopRequireDefault(_libSegment);var _libLineEquation=require("./lib/LineEquation");var _libLineEquation2=_interopRequireDefault(_libLineEquation);var _libMathHelper=require("./lib/MathHelper");var MathHelper=_interopRequireWildcard(_libMathHelper);var PerspectiveGrid=function(){function PerspectiveGrid(context,units,squares){_classCallCheck(this,PerspectiveGrid);this._lineCount=units+1;this.gridUnitCount=units;this.context=context;this.squares=squares||[]}_createClass(PerspectiveGrid,[{key:"init",value:function init(tl,tr,br,bl){this._tl=tl;this._tr=tr;this._br=br;this._bl=bl;this.horizontal=[];this.vertical=[];var dy=(this._bl.y-this._tl.y)/this.gridUnitCount;var dx=(this._tr.x-this._tl.x)/this.gridUnitCount;for(var y=this._tl.y;y<=this._bl.y+MathHelper.EPSILON;y+=dy){this.horizontal[this.horizontal.length]=new _libSegment2["default"](new _libPoint2["default"](this._tl.x,y),new _libPoint2["default"](this._tr.x,y))}for(var x=this._tl.x;x<=this._tr.x+MathHelper.EPSILON;x+=dx){this.vertical[this.vertical.length]=new _libSegment2["default"](new _libPoint2["default"](x,this._tl.y),new _libPoint2["default"](x,this._bl.y))}}},{key:"draw",value:function draw(){this.drawSquares();this.drawLines()}},{key:"update",value:function update(){var vVanishing=this._getVanishingEquation(MathHelper.getLineParams(this._tl.x,this._tl.y,this._bl.x,this._bl.y),MathHelper.getLineParams(this._tr.x,this._tr.y,this._br.x,this._br.y));var hVanishing=this._getVanishingEquation(MathHelper.getLineParams(this._tl.x,this._tl.y,this._tr.x,this._tr.y),MathHelper.getLineParams(this._bl.x,this._bl.y,this._br.x,this._br.y));var horizon=this._getHorizon(vVanishing,hVanishing);var topLine=MathHelper.getLineParams(this._tl.x,this._tl.y,this._tr.x,this._tr.y);var bottomLine=MathHelper.getLineParams(this._bl.x,this._bl.y,this._br.x,this._br.y);var leftLine=MathHelper.getLineParams(this._tl.x,this._tl.y,this._bl.x,this._bl.y);var rightLine=MathHelper.getLineParams(this._tr.x,this._tr.y,this._br.x,this._br.y);if(horizon!==null){horizon=new _libLineEquation2["default"](horizon,vVanishing.x)}topLine=new _libLineEquation2["default"](topLine,this._tl.x);bottomLine=new _libLineEquation2["default"](bottomLine,this._bl.x);leftLine=new _libLineEquation2["default"](leftLine,this._tl.x);rightLine=new _libLineEquation2["default"](rightLine,this._tr.x);var horizontal=undefined;var vertical=undefined;if(horizon===null){horizontal=this._getEquidistantLines(this._tl,this._bl,this._tr,this._br);vertical=this._getEquidistantLines(this._tl,this._tr,this._bl,this._br)}else{horizontal=this._getLines(topLine,bottomLine,horizon,hVanishing);vertical=this._getLines(leftLine,rightLine,horizon,vVanishing)}this._updateLines(topLine,bottomLine,vertical,this.vertical);this._updateLines(leftLine,rightLine,horizontal,this.horizontal)}},{key:"getQuadAt",value:function getQuadAt(column,row){var p1=this.horizontal[row-1].intersect(this.vertical[column-1]);var p2=this.horizontal[row-1].intersect(this.vertical[column]);var p3=this.horizontal[row].intersect(this.vertical[column-1]);var p4=this.horizontal[row].intersect(this.vertical[column]);if(this.debug){this.drawPoint(p1,4,"black");this.drawPoint(p2,4,"black");this.drawPoint(p3,4,"black");this.drawPoint(p4,4,"black")}return[p1,p2,p3,p4]}},{key:"getCenterAt",value:function getCenterAt(column,row){var center=MathHelper.getMassCenter.apply(null,this.getQuadAt(column,row));if(this.debug){this.drawPoint(center,4)}return center}},{key:"drawLines",value:function drawLines(){var segments=this.vertical.concat(this.horizontal);for(var i=0;i<segments.length;i++){this.context.beginPath();this.context.moveTo(segments[i].p1.x,segments[i].p1.y);this.context.lineTo(segments[i].p2.x,segments[i].p2.y);this.context.stroke();this.context.closePath()}}},{key:"drawSquares",value:function drawSquares(){var points=this.squares;for(var i=0;i<points.length;i++){var point=points[i];if(point.x>this.gridUnitCount||point.y>this.gridUnitCount){throw new Error("Point "+point.x+", "+point.x+" is not in the grid.")}var p1=this.horizontal[point.y-1].intersect(this.vertical[point.x-1]);var p2=this.horizontal[point.y-1].intersect(this.vertical[point.x]);var p3=this.horizontal[point.y].intersect(this.vertical[point.x-1]);var p4=this.horizontal[point.y].intersect(this.vertical[point.x]);this.context.moveTo(p1.x,p1.y);this.context.lineTo(p2.x,p2.y);this.context.lineTo(p4.x,p4.y);this.context.lineTo(p3.x,p3.y)}this.context.fill()}},{key:"drawPoint",value:function drawPoint(point,radius,color){this.context.save();this.context.beginPath();this.context.arc(point.x-radius/2,point.y-radius/2,radius,0,MathHelper.TWO_PI,false);this.context.fillStyle=color||"grey";this.context.fill();this.context.restore()}},{key:"_updateLines",value:function _updateLines(side,oppositeSide,lineEquations,segments){for(var i=0;i<lineEquations.length;i++){var line=lineEquations[i];var begin=side.intersect(line);var end=oppositeSide.intersect(line);if(begin===null||end===null){continue}segments[i].p1.x=~~begin.x;segments[i].p1.y=~~begin.y;segments[i].p2.x=~~end.x;segments[i].p2.y=~~end.y}}},{key:"_getVanishingEquation",value:function _getVanishingEquation(side,oppositeSide){var vanishing=undefined;if(side===null&&oppositeSide===null){vanishing=null}else if(side===null){vanishing=new _libPoint2["default"](this._tl.x,MathHelper.getVerticalConvergence(this._tl.x,oppositeSide.m,oppositeSide.c))}else if(oppositeSide===null){vanishing=new _libPoint2["default"](this._tr.x,MathHelper.getVerticalConvergence(this._tr.x,side.m,side.c))}else{vanishing=MathHelper.getConvergencePoint(side.m,side.c,oppositeSide.m,oppositeSide.c)}return vanishing}},{key:"_getEquidistantLines",value:function _getEquidistantLines(sideStart,sideEnd,matchingStart,matchingEnd){var lines=[];var delta=new _libPoint2["default"]((sideEnd.x-sideStart.x)/this.gridUnitCount,(sideEnd.y-sideStart.y)/this.gridUnitCount);var matchingDelta=new _libPoint2["default"]((matchingEnd.x-matchingStart.x)/this.gridUnitCount,(matchingEnd.y-matchingStart.y)/this.gridUnitCount);for(var i=0;i<this._lineCount;i++){var begin=new _libPoint2["default"](sideStart.x+i*delta.x,sideStart.y+i*delta.y);var end=new _libPoint2["default"](matchingStart.x+i*matchingDelta.x,matchingStart.y+i*matchingDelta.y);var lineParams=MathHelper.getLineParams(begin.x,begin.y,end.x,end.y);var line=new _libLineEquation2["default"](lineParams,begin.x);lines.push(line)}return lines}},{key:"_getLines",value:function _getLines(side,oppositeSide,horizon,vanishingPoint){var projectedSide=side.intersect(horizon);var projectedOppositeSide=oppositeSide.intersect(horizon);if(projectedSide===null||projectedOppositeSide===null){return}var distance=new _libPoint2["default"](projectedOppositeSide.x-projectedSide.x,projectedOppositeSide.y-projectedSide.y);var dx=distance.x/this.gridUnitCount;var dy=distance.y/this.gridUnitCount;var results=[];for(var i=0;i<this._lineCount;i++){var startPoint=new _libPoint2["default"](projectedSide.x+i*dx,projectedSide.y+i*dy);var line=MathHelper.getLineParams(startPoint.x,startPoint.y,vanishingPoint.x,vanishingPoint.y);results.push(new _libLineEquation2["default"](line,startPoint.x))}return results}},{key:"_getHorizon",value:function _getHorizon(vVanishing,hVanishing){if(vVanishing===null&&hVanishing===null){return null}else if(vVanishing===null){return null}else if(hVanishing===null){return null}var horizon=MathHelper.getLineParams(vVanishing.x,vVanishing.y,hVanishing.x,hVanishing.y);var furthestFromHorizon=this._tl;var distanceToHorizon=MathHelper.getDistanceToLine(horizon,this._tl);[this._tr,this._bl,this._br].forEach(function(element){var distance=MathHelper.getDistanceToLine(horizon,element);if(distance>distanceToHorizon){distanceToHorizon=distance;furthestFromHorizon=element}});return MathHelper.getParallelLine(horizon,furthestFromHorizon)}}]);return PerspectiveGrid}();exports["default"]=PerspectiveGrid;module.exports=exports["default"]},{"./lib/LineEquation":1,"./lib/MathHelper":2,"./lib/Point":3,"./lib/Segment":4}]},{},[5])(5)});